{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <h2 class="mb-4">Company Chat</h2>
  <div class="card p-4">
    <div id="chat-window" class="mb-3 border rounded p-3" style="height:300px; overflow-y:auto; background:#f8f9fa;"></div>
    <div class="input-group">
      <input type="text" id="chat-input" class="form-control" placeholder="Type your message...">
      <button id="send-btn" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>
<script>
const companyId = "{{ company.id }}";
const username = "{{ user.username }}";
const chatSocket = new WebSocket(
  'ws://' + window.location.host + '/ws/chat/' + companyId + '/'
);

function appendMessage(username, message, timestamp) {
  const chatWindow = document.getElementById('chat-window');
  const msgDiv = document.createElement('div');
  msgDiv.innerHTML = `<strong>${username}</strong> <span class='text-muted small'>${timestamp}</span><br>${message}`;
  chatWindow.appendChild(msgDiv);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  appendMessage(data.username, data.message, data.timestamp);
};

document.getElementById('send-btn').onclick = function() {
  const input = document.getElementById('chat-input');
  const message = input.value;
  if (message.trim() !== '') {
    chatSocket.send(JSON.stringify({ 'message': message }));
    // Show "Message sent!" notification
    let statusDiv = document.getElementById('chat-status');
    if (!statusDiv) {
      statusDiv = document.createElement('div');
      statusDiv.id = 'chat-status';
      statusDiv.className = 'mt-2 text-success';
      input.parentNode.parentNode.appendChild(statusDiv);
    }
    statusDiv.textContent = 'Message sent!';
    statusDiv.style.display = 'block';
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 1000);
    input.value = '';
  }
};
</script>
{% endblock %}
