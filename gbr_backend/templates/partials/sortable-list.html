{% load static %}
{# Reusable sortable list partial template with Mobile & Accessibility Support #}
{# Usage: {% include 'partials/sortable-list.html' with items=items container_id='my-list' container_type='companies' model_name='Company' #}

<div class="sortable-container">
    {% if items %}
        <!-- Sortable List Container with Enhanced Accessibility -->
        <div id="{{ container_id }}" 
             class="sortable-list" 
             data-sortable 
             data-container-type="{{ container_type }}"
             data-model-type="{{ container_type }}"
             data-sortable-options='{"handle": ".drag-handle", "animation": 150}'
             role="application"
             aria-label="Sortable list of {{ container_type }}. Use keyboard navigation to reorder items."
             aria-describedby="keyboard-help">
            
            {% for item in items %}
                <div class="draggable-item" 
                     data-id="{{ item.id }}" 
                     id="{{ container_type }}-{{ item.id }}"
                     tabindex="0"
                     role="listitem"
                     aria-posinset="{{ forloop.counter }}"
                     aria-setsize="{{ items|length }}"
                     aria-label="{{ item.name }} - Position {{ forloop.counter }} of {{ items|length }}">
                    <div class="card-body">
                        <!-- Drag Handle with Accessibility -->
                        {% if user.is_authenticated %}
                            <div class="drag-handle" 
                                 title="Drag to reorder {{ item.name }}"
                                 aria-label="Drag to reorder {{ item.name }}"
                                 aria-describedby="keyboard-help"
                                 tabindex="0"
                                 role="button">
                                <i class="fas fa-grip-vertical" aria-hidden="true"></i>
                                <span class="sr-only">Drag handle for {{ item.name }}</span>
                            </div>
                        {% endif %}
                        
                        <!-- Item Content -->
                        <div class="item-content">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <h5 class="item-title mb-2">{{ item.name }}</h5>
                                    
                                    <!-- Model-specific metadata -->
                                    {% if model_name == 'Country' and item.continent %}
                                        <div class="item-meta mb-2">
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-globe" aria-hidden="true"></i> 
                                                <span class="sr-only">Continent:</span>
                                                {{ item.continent.name }}
                                            </span>
                                        </div>
                                    {% elif model_name == 'Industry' and item.country %}
                                        <div class="item-meta mb-2">
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-map-marker-alt" aria-hidden="true"></i> 
                                                <span class="sr-only">Country:</span>
                                                {{ item.country.name }}
                                            </span>
                                        </div>
                                    {% elif model_name == 'Company' and item.industry %}
                                        <div class="item-meta mb-2">
                                            <span class="badge bg-light text-dark me-2">
                                                <i class="fas fa-industry" aria-hidden="true"></i> 
                                                <span class="sr-only">Industry:</span>
                                                {{ item.industry.name }}
                                            </span>
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-map-marker-alt" aria-hidden="true"></i> 
                                                <span class="sr-only">Country:</span>
                                                {{ item.industry.country.name }}
                                            </span>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Description (if available) -->
                                    {% if item.description %}
                                        <p class="item-description mb-3">{{ item.description|truncatewords:20 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Action Buttons with Enhanced Accessibility -->
                            <div class="d-flex gap-2 flex-wrap">
                                {% if model_name == 'Country' %}
                                    <a href="{% url 'list_industries' item.id %}" 
                                       class="btn btn-primary btn-sm"
                                       aria-label="View industries in {{ item.name }}">
                                        <i class="fas fa-industry" aria-hidden="true"></i> 
                                        View Industries
                                    </a>
                                {% elif model_name == 'Industry' %}
                                    <a href="{% url 'list_companies' item.id %}" 
                                       class="btn btn-primary btn-sm"
                                       aria-label="View companies in {{ item.name }}">
                                        <i class="fas fa-building" aria-hidden="true"></i> 
                                        View Companies
                                    </a>
                                {% elif model_name == 'Company' %}
                                    <a href="{% url 'company_detail' item.id %}" 
                                       class="btn btn-primary btn-sm"
                                       aria-label="View details for {{ item.name }}">
                                        <i class="fas fa-eye" aria-hidden="true"></i> 
                                        View Details
                                    </a>
                                    
                                    {% if user.is_authenticated %}
                                        <a href="{% url 'chat' item.id %}" 
                                           class="btn btn-outline-success btn-sm"
                                           aria-label="Start chat with {{ item.name }}">
                                            <i class="fas fa-comments" aria-hidden="true"></i> 
                                            Chat
                                        </a>
                                        
                                        <a href="{% url 'video_chat' item.id %}" 
                                           class="btn btn-outline-info btn-sm"
                                           aria-label="Start video call with {{ item.name }}">
                                            <i class="fas fa-video" aria-hidden="true"></i> 
                                            Video
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Enhanced Sorting Instructions with Accessibility -->
        {% if user.is_authenticated %}
            <div class="alert alert-light mt-4" role="region" aria-labelledby="sort-instructions">
                <div class="d-flex align-items-start">
                    <i class="fas fa-info-circle text-info me-2 mt-1" aria-hidden="true"></i>
                    <div>
                        <h6 id="sort-instructions" class="mb-2">Sorting Instructions:</h6>
                        <ul class="mb-0 small">
                            <li><strong>Mouse/Touch:</strong> Drag and drop {{ model_name|lower }}s using the 
                                <i class="fas fa-grip-vertical" aria-hidden="true"></i> handle to reorder them.</li>
                            <li><strong>Keyboard:</strong> Focus an item, press <kbd>Space</kbd> to pick up, 
                                use <kbd>↑</kbd>/<kbd>↓</kbd> to move, <kbd>Space</kbd> to drop, <kbd>Esc</kbd> to cancel.</li>
                            <li>Changes are saved automatically.</li>
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
        
    {% else %}
        <!-- Enhanced Empty State with Accessibility -->
        <div class="text-center py-5" role="region" aria-label="Empty state">
            <div class="empty-state">
                {% if model_name == 'Country' %}
                    <i class="fas fa-globe fa-4x text-muted mb-3" aria-hidden="true"></i>
                    <h4 class="text-muted mb-3">No Countries Available</h4>
                    <p class="text-muted mb-4">
                        There are currently no countries listed in this continent.
                    </p>
                {% elif model_name == 'Industry' %}
                    <i class="fas fa-industry fa-4x text-muted mb-3" aria-hidden="true"></i>
                    <h4 class="text-muted mb-3">No Industries Available</h4>
                    <p class="text-muted mb-4">
                        There are currently no industries listed in this country.
                    </p>
                {% elif model_name == 'Company' %}
                    <i class="fas fa-building fa-4x text-muted mb-3" aria-hidden="true"></i>
                    <h4 class="text-muted mb-3">No Companies Available</h4>
                    <p class="text-muted mb-4">
                        There are currently no companies listed in this industry.
                    </p>
                {% endif %}
                
                <div class="d-flex gap-2 justify-content-center">
                    {% if user.is_staff %}
                        <a href="/admin/core/{{ model_name|lower }}/add/" 
                           class="btn btn-primary"
                           aria-label="Add new {{ model_name|lower }}">
                            <i class="fas fa-plus" aria-hidden="true"></i> 
                            Add {{ model_name }}
                        </a>
                    {% endif %}
                    {% if back_url %}
                        <a href="{{ back_url }}" 
                           class="btn btn-outline-secondary"
                           aria-label="Go back to previous page">
                            <i class="fas fa-arrow-left" aria-hidden="true"></i> 
                            Go Back
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Enhanced Loading State Template with Accessibility -->
<div id="loading-{{ container_id }}" 
     class="loading-state text-center py-5" 
     style="display: none;"
     role="status"
     aria-live="polite"
     aria-label="Loading content">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading {{ model_name|lower }}s...</p>
</div>

<!-- Enhanced Error State Template with Accessibility -->
<div id="error-{{ container_id }}" 
     class="error-state alert alert-danger" 
     style="display: none;" 
     role="alert"
     aria-live="assertive">
    <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle me-3" aria-hidden="true"></i>
        <div>
            <strong>Error Loading {{ model_name }}s</strong><br>
            <small>Unable to load the {{ model_name|lower }} list. Please try refreshing the page.</small>
        </div>
        <button type="button" 
                class="btn btn-outline-danger btn-sm ms-auto" 
                onclick="location.reload()"
                aria-label="Retry loading {{ model_name|lower }}s">
            <i class="fas fa-redo" aria-hidden="true"></i> 
            Retry
        </button>
    </div>
</div>

<!-- Enhanced JavaScript Initialization with Mobile & Accessibility Support -->
{% if items and user.is_authenticated %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize drag & drop for {{ container_id }} with mobile and accessibility support
    if (window.gbrDragDrop && document.getElementById('{{ container_id }}')) {
        // Show loading state
        const loadingElement = document.getElementById('loading-{{ container_id }}');
        if (loadingElement) {
            loadingElement.style.display = 'block';
        }
        
        try {
            window.gbrDragDrop.initSortable('{{ container_id }}', {
                containerType: '{{ container_type }}',
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                // Mobile optimizations
                touchStartThreshold: 0,
                forceFallback: window.gbrDragDrop.isTouchDevice(),
                fallbackTolerance: 5,
                delayOnTouchStart: true,
                delay: window.gbrDragDrop.isTouchDevice() ? 200 : 0,
                // Custom options for {{ model_name }}
                onStart: function(evt) {
                    console.log('Started dragging {{ model_name|lower }}:', evt.item.dataset.id);
                    // Announce to screen readers
                    if (window.gbrDragDrop.announceToScreenReader) {
                        const itemTitle = evt.item.querySelector('.item-title')?.textContent || '{{ model_name }}';
                        window.gbrDragDrop.announceToScreenReader(`Started moving ${itemTitle}`);
                    }
                },
                onEnd: function(evt) {
                    console.log('Finished dragging {{ model_name|lower }}:', evt.item.dataset.id);
                },
                onError: function(error) {
                    console.error('Error with {{ model_name|lower }} drag & drop:', error);
                    // Show error state
                    const errorElement = document.getElementById('error-{{ container_id }}');
                    if (errorElement) {
                        errorElement.style.display = 'block';
                    }
                    // Announce error to screen readers
                    if (window.gbrDragDrop.announceToScreenReader) {
                        window.gbrDragDrop.announceToScreenReader('Error occurred while reordering items');
                    }
                }
            });
            
            console.log('{{ model_name }} drag & drop initialized successfully for {{ container_id }}');
            
            // Hide loading state
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
        } catch (error) {
            console.error('Failed to initialize {{ model_name|lower }} drag & drop:', error);
            
            // Hide loading and show error
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            const errorElement = document.getElementById('error-{{ container_id }}');
            if (errorElement) {
                errorElement.style.display = 'block';
            }
        }
    } else {
        console.warn('GBR Drag & Drop system not available or no {{ model_name|lower }} list found');
        
        // Show error state if drag & drop is not available
        const errorElement = document.getElementById('error-{{ container_id }}');
        if (errorElement && window.gbrDragDrop === undefined) {
            errorElement.style.display = 'block';
        }
    }
});
</script>
{% endif %}
