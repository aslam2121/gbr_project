{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <h2 class="mb-4">Video Chat</h2>
  <div class="card p-4">
    <div id="video-chat-area" class="mb-3">
      <video id="localVideo" autoplay muted playsinline class="border rounded w-100 mb-2" style="max-height:300px;"></video>
      <video id="remoteVideo" autoplay playsinline class="border rounded w-100" style="max-height:300px;"></video>
    </div>
    <div class="d-flex gap-2">
      <button id="startCallBtn" class="btn btn-success">Start Call</button>
      <button id="endCallBtn" class="btn btn-danger">End Call</button>
    </div>
    <div id="status" class="mt-3 text-muted"></div>
  </div>
</div>
<script>
const companyId = "{{ company.id }}";
const username = "{{ user.username }}";
const ws = new WebSocket('ws://' + window.location.host + '/ws/video/' + companyId + '/');
let localStream, peerConnection;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const startCallBtn = document.getElementById('startCallBtn');
const endCallBtn = document.getElementById('endCallBtn');
const statusDiv = document.getElementById('status');

ws.onopen = function() {
  console.log('WebSocket connection opened');
};
ws.onerror = function(e) {
  console.error('WebSocket error:', e);
};
ws.onclose = function() {
  console.log('WebSocket connection closed');
};

ws.onmessage = function(e) {
  console.log('WebSocket message received:', e.data);
  const data = JSON.parse(e.data);
  if (!peerConnection) {
    console.warn('PeerConnection not initialized when message received');
    return;
  }
  if (data.signal.type === 'offer') {
    console.log('Received offer');
    peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal)).then(() => {
      console.log('Remote description set (offer)');
      peerConnection.createAnswer().then(answer => {
        peerConnection.setLocalDescription(answer);
        ws.send(JSON.stringify({ signal: answer, username }));
        console.log('Sent answer');
      });
    });
  } else if (data.signal.type === 'answer') {
    console.log('Received answer');
    peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal)).then(() => {
      console.log('Remote description set (answer)');
    });
  } else if (data.signal.candidate) {
    console.log('Received ICE candidate');
    peerConnection.addIceCandidate(new RTCIceCandidate(data.signal.candidate)).then(() => {
      console.log('ICE candidate added');
    }).catch(err => {
      console.error('Error adding ICE candidate:', err);
    });
  }
};

startCallBtn.onclick = async function() {
  try {
    console.log('Requesting local media...');
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    console.log('Local media stream started');
    peerConnection = new RTCPeerConnection(config);
    peerConnection.onicecandidate = e => {
      if (e.candidate) {
        ws.send(JSON.stringify({ signal: { candidate: e.candidate }, username }));
        console.log('Sent ICE candidate');
      }
    };
    peerConnection.ontrack = e => {
      console.log('Remote track received');
      remoteVideo.srcObject = e.streams[0];
    };
    localStream.getTracks().forEach(track => {
      peerConnection.addTrack(track, localStream);
      console.log('Added local track:', track.kind);
    });
    peerConnection.createOffer().then(offer => {
      peerConnection.setLocalDescription(offer);
      ws.send(JSON.stringify({ signal: offer, username }));
      statusDiv.textContent = "Calling...";
      console.log('Sent offer');
    });
  } catch (err) {
    console.error('Error starting call:', err);
    statusDiv.textContent = 'Error starting call: ' + err;
  }
};

endCallBtn.onclick = function() {
  if (peerConnection) {
    peerConnection.close();
    console.log('PeerConnection closed');
  }
  statusDiv.textContent = "Call ended.";
};
</script>
{% endblock %}
